# Http学习笔记

## TCP/IP 有哪些层？

链接层

负责在以太网、WiFi这样的底层网络上发送原始数据包，使用MAC地址来标记网络上的设备

网际层

用IP地址取代MAC地址，把局域网、广域网连接成一个巨大网络，在找设备时只需把IP地址翻译成MAC地址即可

传输层

保证数据在IP地址标记的两点之间“可靠”地传输

TCP 是一个有状态的协议，需要先建立连接才能发送数据，保证数据不丢失不重复

UDP是无状态的，不用事先建立连接就可以发送数据，不可靠

数据的形式: TCP 连续的字节流，有先后顺序，UDP是分散的小数据包，顺序发，乱序收

应用层

常见的协议有 Telnet, SSH, FTP, SMTP, DNS, HTTP 等



交换机和路由器工作在哪一层？

二层转发，三层路由



TCP/IP协议栈的工作方式可以类比送快递，先把物品套个袋(HTTP)，在装个盒子贴个标签(TCP)，把包裹放入三轮车，运大集散点，装进大卡车，相当于在IP层、MAC层对TCP数据包加上了IP头、MAC头。



待整理

TCP ，UDP，HTTP报文结构 

HTTP 报文结构，请求相应头，内部请求方法，URI，状态码



优缺点

1. 灵活可扩展：报文里各个组成部分没有做严格的语法语义限制，可任意定制；body等传输任意数据；
2. 可靠传输：基于TCP/IP协议，TCP本身是可靠的传输协议，HTTP自然继承了这一特性。对实际传输的数据做了一层包装，加上一个头，然后调用Socket API，通过TCP/IP协议栈发送或者接收；
3. 应用层协议：几乎可以传递一切东西，满足各种需求
4. 请求-应答模式：契合传统 C/S 架构模式，B/S 架构，催生了WebService, RESTFul和gRPC等；
5. 无状态：TCP 是有状态的，一开始是 CLOSED，连接成功后是 ESTABLISHED，断开连接后是 FIN-WAIT，最后又是 CLOSED。UDP 是无连接无状态的，顺序发包乱序收包，包发出去后就不管了。无状态即没有“记忆力”，每次收发报文都是相互独立的，没有任何联系，HTTP 是有连接无状态的，虽然标准里没有规定状态，但可以自己增加这个特性，如 cookie, session, token；
6. 传输数据可压缩，支持身份认证，支持国际化语言等

性能

不算差，不够好。

短连接，每次请求时都要进行三次握手，性能较差。

HTTP/1.1 默认开启长连接，Connection: keep-alive 字段。握手完后不断开，连接一直保持，节省了重复握手的开销。

大量的长连接会耗尽服务器资源，在请求头添加 Connection: close 字段，即可告知服务器在这次通信后关闭连接。服务器不会主动关闭连接，但可以使用一些策略，如设置 keepalive_timeout 指令，设置长连接的超时时间；使用 keepalive_requests 指令，设置长连接上可发送的最大请求次数。

队头阻塞

HTTP报文规定必须是一发一收，形成一个先进先出的串行队列，如果队首处理较慢，那么队列后面的所有请求都得等待。

性能优化

请求-响应 模式不能变，队头阻塞在 HTTP/1.1 里无法解决，于是用用数量来解决这个问题。使用“并发连接”，即对一个域名同时发起多个长连接（chrome对同域名并发连接数限制为6个），并使用域名分片（多个域名都指向同一服务器，等于绕过了浏览器域名连接数限制）

重定向

分为永久重定向(301)和临时重定向(302)，在服务器端拥有主动权，

重定向的需求：1.资源不可用，如服务器变更，域名变更等，为了避免404，使用重定向跳转到新的URI；2.避免重复，如让多个域名都重定向到一个入口网站。

永久重定向场景：域名、服务器、网站架构发生大幅度改变，原来的URI已经不能用了等。

临时重定向场景：原来的URI在将来的某个时间点还会恢复正常，如系统维护，服务降级等。

Cookie

因为HTTP是无状态的，所以使用Cookie来作为一种记忆能力，让服务端识别出客户端。在向服务端发送请求后，服务端有时会在响应头中包含 Set-cookie: a=xx 这种字段，浏览器在请求头中添加 Cookie: a=xx，Cookie是在浏览器端存储的。

Cookie一般会记录用户的关键识别信息，所以需要一些措施，防止外泄或者窃取。如Cookie的生存周期（Expires, Max-age）、作用域（Domain, Path，与URI中的host和path是否一致）、安全性（HttpOnly 只能用HTTP协议传输， SameSite 防范跨站请求伪造，Secure 表示 Cookie 仅能用HTTPS协议加密传输）。

Cookie 用途：1. 身份识别；2.广告跟踪



TLS1.2的四次握手，TLS1.3的改进

HTTP/2的特性

HTTPS在安全方面已经做得非常好了，所以HTTP/2唯一目标就是改进性能。

报头压缩：使用HPACK算法，避免重发发送同样的请求头

二进制格式：把TCP协议的部分特性挪到了应用层，把原来的“Header + Body”的消息打散为数个小片的二进制“帧”，用“HEADERS‘帧存放头数据，”DATA“帧存放实体数据。

流：它是二进制的双向传输序列，同一个消息往返的帧会分配一个唯一的流ID。HTTP/2可以在一个TCP连接上用”流“同时发送多个碎片化的消息，即多路复用——多个往返通信都复用一个连接来处理。

在”流“的层面来看，消息是一些有序的”帧’序列，在“连接”的层面上看，消息却是乱序收发的“帧”。多个请求/响应之间没有了顺序关系，不需要排队等待，也就不会再出现“队头阻塞”















